# Анализ технологий, структурирование данных и проектирование архитектуры локальной OCR-системы (─‿‿─)

## 1. Анализ существующих решений по OCR и структурированному распознаванию
Поскольку главным требованием является локальная работа системы (без отправки конфиденциальных документов в облако), коммерческие API (Yandex Vision, Google Cloud Vision) мы исключаем из финального стека, но держим в уме как эталон качества (baseline).

Рассмотрим Open-Source решения для локального развертывания:

### A. Классические и легковесные OCR-движки
* **Tesseract OCR:** Ветеран индустрии. Хорошо работает с чистым текстом, но сильно страдает при сложной верстке (таблицы в ТТН) и требует мощного препроцессинга изображений.
* **EasyOCR:** Легковесная нейросетевая библиотека. Хорошо читает русский язык, но имеет проблемы с определением структуры сложных таблиц.
* **PaddleOCR:** (Лидер в этой категории) Отличное распознавание текста, поддержка русского языка «из коробки», высокая скорость работы и, главное, наличие встроенных моделей для распознавания таблиц (Table Recognition) и структуры документа (Layout Analysis).

### B. Модели понимания документов (Document Understanding / VLM)
* **LayoutLM (v2/v3):** Модели от Microsoft, которые учитывают не только текст, но и его координаты (bounding boxes) и изображение. Идеально для извлечения пар "Ключ-Значение" из ТТН.
* **Donut / Nougat:** Модели, работающие по принципу Image-to-Text (без промежуточного OCR). Выдают сразу структурированный JSON. Минус — требуют много ресурсов и дообучения под специфичные формы ТТН.
* **Локальные LLM (например, Qwen2-VL, Llama-3 + OCR):** Использование легкой локальной визуальной модели (до 8B параметров) для извлечения данных прямо из скана.

**Вывод по стеку:** Для баланса между скоростью, точностью и требованиями к железу (демо-стенд), оптимальным решением будет гибридный пайплайн:
* Использование PaddleOCR для извлечения текста и поиска таблиц.
* Использование регулярных выражений (RegEx) + легкой локальной LLM (или LayoutLM) для маппинга текста в JSON-структуру.

## 2. Определение структуры ТТН (Товарно-транспортной накладной)
ТТН (форма 1-Т или ее вариации) имеет сложную структуру, включающую шапку, информацию о контрагентах и табличную часть. Нам необходимо определить минимально жизнеспособный набор (MVP) полей для извлечения.

Формат структурированного вывода (Target JSON Structure):

```json
{
  "document_meta": {
    "doc_number": "Номер документа (строка)",
    "doc_date": "Дата составления (DD.MM.YYYY)"
  },
  "participants": {
    "shipper": "Грузоотправитель (Название компании)",
    "consignee": "Грузополучатель (Название компании)",
    "payer": "Плательщик (Название компании)",
    "carrier": "Перевозчик (Название компании)"
  },
  "vehicle_info": {
    "car_brand": "Марка автомобиля",
    "license_plate": "Гос. номер",
    "driver_name": "ФИО водителя"
  },
  "goods_table": [
    {
      "item_id": "Номенклатурный номер",
      "name": "Наименование товара",
      "unit": "Ед. измерения",
      "quantity": "Количество",
      "price_per_unit": "Цена за ед.",
      "total_price": "Сумма"
    }
  ],
  "totals": {
    "total_quantity": "Итого количество",
    "total_amount": "Итого сумма к оплате"
  }
}
```
## 3. Проектирование архитектуры локальной системы
Система будет построена по принципу микросервисной/модульной архитектуры. Все работает локально на машине демо-стенда.

### Логическая схема конвейера (Pipeline):

**Модуль ввода и препроцессинга (Image Preprocessing)**
* **Вход:** Фотография со смартфона или скан.
* **Действия:** Перевод в градации серого, бинаризация, выравнивание наклона (Deskewing), обрезка фона (Document Edge Detection).
* **Инструменты:** OpenCV, Python.

**Модуль извлечения текста и верстки (OCR & Layout Engine)**
* **Вход:** Очищенное изображение.
* **Действия:** Нахождение блоков текста, определение структуры таблиц, распознавание символов.
* **Инструменты:** PaddleOCR (Layout Analysis + Table Recognition).

**Модуль структурирования (Information Extraction)**
* **Вход:** Массив "сырого" текста с координатами (Bounding Boxes).
* **Действия:** Поиск ключевых слов ("Грузоотправитель", "Итого" и т.д.), привязка соседних текстовых блоков к ключам, сборка табличных данных.
* **Инструменты:** Rule-based алгоритмы (Python) + легкая локальная LLM (опционально, через Ollama для коррекции ошибок OCR).

**Модуль API и Frontend (Пользовательский интерфейс)**
* **Вход:** Данные от пользователя (загрузка файла).
* **Выход:** Отображение исходного скана с наложенными рамками (Bounding boxes) и готовый JSON/Таблица.
* **Инструменты:** FastAPI (бэкенд) + Streamlit или Gradio (фронтенд — идеально для демо-стендов).

### Схема взаимодействия (Flowchart):

```text
[ Пользователь ] -> (Загружает фото ТТН в Web-UI на Streamlit)
       |
       v
[ FastAPI Backend ] -> Сохраняет фото во временную папку
       |
       v
[ OpenCV Препроцессинг ] -> Улучшает качество (контраст, выравнивание)
       |
       v
[ PaddleOCR ] -> Выдает список: [Текст, Координаты (X,Y), Уверенность (%)]
       |
       v
[ Парсер / Extractor ] -> Превращает сырой текст в структурированный JSON (по схеме ТТН)
       |
       v
[ FastAPI Backend ] -> Возвращает JSON на Frontend
       |
       v
[ Streamlit Web-UI ] -> Показывает пользователю:
                        1. Оригинальное фото
                        2. Красивую табличку с извлеченными данными
                        3. Кнопку "Скачать в Excel/JSON"
